

 




    
### Buscador de Farmacias de Barcelona ciudad

Nos han encargado realizar un mapa para poder localizar y buscar las farmacias de Barcelona y para cada farmácia poder visualizar las cinco más cercanas

- Los datos de farmacias se pueden obtener de la web de Datos Abiertos de Barcelona [https://opendata-ajuntament.barcelona.cat/data/es/dataset/sanitat-farmacies](https://opendata-ajuntament.barcelona.cat/data/es/dataset/sanitat-farmacies){target=_blank} 

- Podemos transformar los datos  **GeoJson** y cargalos com un source en Mapbox GlJs

- Podemos utilizar el control de **mapbox-gl-geocoder** para buscar en GeoJson de forma local

    
### Ejemplo buscador de Farmacias

#### Paso 1:Visualizar datos 
      
 *  Dentro de **/geoweb/datos/farmacias.geojson** ya tenemos los datos descargados y convertidos a GeoJson. Podemos visualizarlos con [https://geojson.io/#map=2/0/20](https://geojson.io/#map=2/0/20){target=_blank} por ejemplo

!!! tip "Convertir a GeoJson"

    El archivo de farmacias lo hemos descargado del portal [https://opendata-ajuntament.barcelona.cat/data/es/dataset/sanitat-farmacies](https://opendata-ajuntament.barcelona.cat/data/es/dataset/sanitat-farmacies){target=_blank} en formato CSV y lo hemos transformado a GeoJSON

    Para ver cómo transformar y reproyectar un archivo CSV a GeoJson con Qgis mira el **video 10**


#### Paso 2: Crear archivo farmacias.html dentro de /geoweb

```html
<html>

<head>
    <meta charset='utf-8' />
    <title>Farmacias</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css' rel='stylesheet' />

    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <link href='css/estilobase.css' rel='stylesheet' />


    <script>
        //Añadir vuestor token y/o estilo !!
        var map;

        function init() {
            mapboxgl.accessToken =
                'pk.eyJ1IjoiZ2lzbWFzdGVybTIiLCJhIjoiY2plZHhubTQxMTNoYzMza3Rqa3kxYTdrOCJ9.53B1E6mKD_EQOVb2Y0-SsA';
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v10',
                center: [2.16859, 41.3954],
                zoom: 15,
                attributionControl: false,
                hash: true
            });

            map.addControl(new mapboxgl.AttributionControl({
                compact: true
            }));
            map.addControl(new mapboxgl.NavigationControl());

        } // final init
    </script>
</head>

<body onload="init()">
    <div id="map"></div>
</body>

</html>
```


#### Paso 3: Crear archivo farmacias.js dentro de /geoweb/js

Llamamos a nuestro geojson de farmacias que está en **datos/farmacias.geojson**

```javascript
function addFarmacias() {

    var url = 'datos/farmacias.geojson';
    map.addSource('farmacias', {
        type: 'geojson',
        data: url
    });

    map.addLayer({
        'id': 'farmacias',
        'type': 'circle',
        'source': 'farmacias',
        'paint': {
            'circle-color': '#00ff00',
            'circle-radius': 5,
            'circle-stroke-color':'#ffffff',
            'circle-stroke-width':2
        }
    });

    
} // fin funcion

```

 <!--


 * Abrimos archivo **mapabase.html** y guardamos como *File->Save as* **farmacias.html**
 * Añadimos un titulo y la función  inicial **initMapaFarmacias()** de nuestro proyecto
* Llamamos a la función **initMapaFarmacias()** en el body onLoad
 ``` html hl_lines="3 14 15 16 17 18 22"
    <html lang="es">
    <head>
        <title>Farmacias</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="autor" />
        <meta name="description" content="descripción página" />
        <meta name="robots" content="index,follow" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

        <link rel="stylesheet" href="css/estilobase.css" />
        <script src="js/mapabase.js"></script>
        <script>       
            function initMapaFarmacias(){
                init();              
            }         
        </script>

    </head>

    <body onLoad="initMapaFarmacias()">
        <div id="map"> </div>
    </body>

    </html>

 ```
#### Paso 3:Añadir plugin

 * Añadimos Plugins al proyecto

   >Podemos descargar plugins del directorio **/dist** y guardarlos en nuestros directorios **/js** o **/css**

   >También podemos utilizar la URL directamente (**nuestro caso**)

``` html hl_lines="12"

<html lang="es">
    <head>
        <title>Farmacias</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="autor" />
        <meta name="description" content="descripción página" />
        <meta name="robots" content="index,follow" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

        <script src="https://calvinmetcalf.github.io/leaflet-ajax/dist/leaflet.ajax.js"></script>

        <link rel="stylesheet" href="css/estilobase.css" />
        <script src="js/mapabase.js"></script>
        <script>       
            function initMapaFarmacias(){
                init();              
            }         
        </script>

    </head>

    <body onLoad="initMapaFarmacias()">
        <div id="map"> </div>
    </body>

    </html>

``` 


#### Paso 4:Cargamos GeoJson Farmacias

 * Miramos documentación Leaflet-Ajax plugin https://github.com/calvinmetcalf/leaflet-ajax
 * Miramos referencia L.Geojson https://leafletjs.com/reference-1.7.1.html#geojson
 * Dentro de nuestro directorio **/geoweb/js/** creamos el archivo **farmacias.js**    

``` javascript
var layerFarmacias;
var urlFarmacias = "datos/farmacias.geojson";

function addDatosFarmacias() {

        layerFarmacias  = new L.GeoJSON.AJAX(urlFarmacias, {
            onEachFeature: function (feature, layer) {
                popupContent = "<b>" + feature.properties.EQUIPAMENT + "</b>"+
                "<br>" + feature.properties.TIPUS_VIA +
                ". " + feature.properties.NOM_CARRER +
                " " + feature.properties.NUM_CARRER_1 + "</b>";
                layer.bindPopup(popupContent);
            },
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 6,
                    fillColor: "#00ff00",
                    color: "#ffffff",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            }
        }).addTo(map);

        map.setView([41.399733,2.168598],13);
        // controlCapas.addOverlay(layerFarmacias,"Farmacias");

}//fin funcion

```


#### Paso 5:

* Añadimos **farmacias.js** al archivo **farmacias.html**
* Llamamos funcion **addDatosFarmacias()**

``` html hl_lines="16 20"
<html lang="es">
    <head>
        <title>Farmacias</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="autor" />
        <meta name="description" content="descripción página" />
        <meta name="robots" content="index,follow" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

        <script src="https://calvinmetcalf.github.io/leaflet-ajax/dist/leaflet.ajax.js"></script>

        <link rel="stylesheet" href="css/estilobase.css" />
        <script src="js/mapabase.js"></script>
        <script src="js/farmacias.js"></script>
        <script>       
            function initMapaFarmacias(){
                init();  
                addDatosFarmacias();            
            }         
        </script>

    </head>

    <body onLoad="initMapaFarmacias()">
        <div id="map"> </div>
    </body>

    </html>
```

* Visualizamos mapa
![alt text](img/leaflet-farmacias0.png "leaflet-farmacias0.png")


#### Paso 6:Añadir opción para buscar Farmacias

 * Miramos documentación Leaflet-Search plugin https://github.com/stefanocudini/leaflet-search
 * Añadimos URL plugin

```html hl_lines="14 15"
<html lang="es">
    <head>
        <title>Farmacias</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="autor" />
        <meta name="description" content="descripción página" />
        <meta name="robots" content="index,follow" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
     
        <script src="https://calvinmetcalf.github.io/leaflet-ajax/dist/leaflet.ajax.js"></script>

        <script src="https://labs.easyblog.it/maps/leaflet-search/src/leaflet-search.js"></script>
        <link rel="stylesheet" href="https://labs.easyblog.it/maps/leaflet-search/src/leaflet-search.css" />

        <link rel="stylesheet" href="css/estilobase.css" />
        <script src="js/mapabase.js"></script>
        <script src="js/farmacias.js"></script>
        <script>       
            function initMapaFarmacias(){
                init();  
                addDatosFarmacias();            
            }         
        </script>

    </head>

    <body onLoad="initMapaFarmacias()">
        <div id="map"> </div>
    </body>

    </html>
```

 * Añadimos el control dentro de la función **addDatosFarmacias()** de  **farmacias.js** 


``` javascript hl_lines="29 30 31 32 33 34 35 36 37 38 39 40 41 42"
var layerFarmacias;
var urlFarmacias = "datos/farmacias.geojson";

function addDatosFarmacias() {

        layerFarmacias  = new L.GeoJSON.AJAX(urlFarmacias, {
            onEachFeature: function (feature, layer) {
                popupContent = "<b>" + feature.properties.EQUIPAMENT + "</b>"+
                "<br>" + feature.properties.TIPUS_VIA +
                ". " + feature.properties.NOM_CARRER +
                " " + feature.properties.NUM_CARRER_1 + "</b>";
                layer.bindPopup(popupContent);
            },
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 6,
                    fillColor: "#00ff00",
                    color: "#ffffff",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            }
        }).addTo(map);

        map.setView([41.399733,2.168598],13);
        // controlCapas.addOverlay(layerFarmacias,"Farmacias");

        var searchControl = new L.Control.Search({
            layer: layerFarmacias,
            initial:false,
            propertyName: 'EQUIPAMENT',
            circleLocation: true,
            moveToLocation: function (latlng) {
                map.setView(latlng, 17);
            }
        });

        searchControl.on('search:locationfound', function(e) {
            e.layer.openPopup();
        });
        map.addControl(searchControl);

} //fin funcion

```

 * Probamos visor y buscamos farmácias

 ![alt text](img/farmacias2.png "farmacias")

#### Paso 7: ¿Añadimos el plugin de Cluster?

Este es uno de lo plugins más utilizados en Leaflet

* Miramos documentación [https://github.com/Leaflet/Leaflet.markercluster](https://github.com/Leaflet/Leaflet.markercluster){target=_blank}


 * Añadimos URL plugin

```html hl_lines="17 18 19"
<html lang="es">
    <head>
        <title>Farmacias</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="autor" />
        <meta name="description" content="descripción página" />
        <meta name="robots" content="index,follow" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
     
        <script src="https://calvinmetcalf.github.io/leaflet-ajax/dist/leaflet.ajax.js"></script>

        <script src="https://labs.easyblog.it/maps/leaflet-search/src/leaflet-search.js"></script>
        <link rel="stylesheet" href="https://labs.easyblog.it/maps/leaflet-search/src/leaflet-search.css" />

        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
        <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>


        <link rel="stylesheet" href="css/estilobase.css" />
        <script src="js/mapabase.js"></script>
        <script src="js/farmacias.js"></script>
        <script>       
            function initMapaFarmacias(){
                init();  
                addDatosFarmacias();            
            }         
        </script>

    </head>

    <body onLoad="initMapaFarmacias()">
        <div id="map"> </div>
    </body>

    </html>
```

* Añadimos la capa dentro de la función **addDatosFarmacias()** de  **farmacias.js** 



``` javascript hl_lines="6 17 30 32"
var layerFarmacias;
var urlFarmacias = "datos/farmacias.geojson";

function addDatosFarmacias() {

        var puntosCluster = L.markerClusterGroup();

        layerFarmacias  = new L.GeoJSON.AJAX(urlFarmacias, {
            onEachFeature: function (feature, layer) {
                popupContent = "<b>" + feature.properties.EQUIPAMENT + "</b>"+
                "<br>" + feature.properties.TIPUS_VIA +
                ". " + feature.properties.NOM_CARRER +
                " " + feature.properties.NUM_CARRER_1 + "</b>";
                layer.bindPopup(popupContent);
            },
            pointToLayer: function (feature, latlng) {
                puntosCluster.addLayer(L.marker(latlng));
                return L.circleMarker(latlng, {
                    radius: 6,
                    fillColor: "#00ff00",
                    color: "#ffffff",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            }
        }).addTo(map);

        map.setView([41.399733,2.168598],13);
        controlCapas.addOverlay(layerFarmacias,"Farmacias");

        controlCapas.addOverlay(puntosCluster,"Cluster");

        var searchControl = new L.Control.Search({
            layer: layerFarmacias,
            initial:false,
            propertyName: 'EQUIPAMENT',
            circleLocation: true,
            moveToLocation: function (latlng) {
                map.setView(latlng, 17);
            }
        });

        searchControl.on('search:locationfound', function(e) {
            e.layer.openPopup();
        });
        map.addControl(searchControl);
       

} //fin funcion

```

* Probamos visualización
![alt text](img/farmacias3.png "farmacias")

!!! success "¿Subimos el ejemplo al GitHub?"
    Acordaros tambiés de actualizar index.html
	
	```bash

		git pull
        git add .
        git commit -m "ejemplos leaflet"
        git push origin main

	```    

!!! tip "Soluciones sesion 2"
    Visualizar [https://gis-master-m2.github.io/geoweb/](https://gis-master-m2.github.io/geoweb/){target=_blank}

    Descargar [https://github.com/gis-master-m2/geoweb/archive/main.zip](https://github.com/gis-master-m2/geoweb/archive/main.zip){target=_blank}


### Anexos 

#### Ejemplos de GeoJSONs con plugin GeoJSON AJAX

> diferentes formas de trabajar con GeoJSONs y el plugin de GeoJSON.AJAX

!!! example "GeoJson por defecto"

    ```javascript

      var comarcasPoligonoDefault = new L.GeoJSON.AJAX('datos/comarcas.geojson').addTo(map);

      var farmaciasPuntoDefault = new L.GeoJSON.AJAX('datos/farmacias.geojson').addTo(map);

      var carrilsBiciLineaDefault = new L.GeoJSON.AJAX('datos/carrils-bici.geojson').addTo(map);

    
            
    ```

!!! example "GeoJson con estilos"

    ```javascript

    var comarcasPoligonoStyle = new L.GeoJSON.AJAX('datos/comarcas.geojson', {
                    style: function (feature) {
                        return {

                            fillColor: "#fab81e",
                            color: "#ffffff",
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.5
                        }
                    }
                }).addTo(map);
      var farmaciasPuntoStyle = new L.GeoJSON.AJAX('datos/farmacias.geojson', {

                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: "#00ff00",
                        color: "#ffffff",
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.8
                    })
                }
            }).addTo(map);

            var carrilsBiciLineaStyle = new L.GeoJSON.AJAX('datos/carrils-bici.geojson', {
                style: function (feature) {
                    return {
                        color: "#d607f2",
                        weight: 6
                    }
                }
            }).addTo(map);

    ```   

!!! example "GeoJson con estilos y Popups"

    ```javascript

    var comarcasPoligonoStylePop = new L.GeoJSON.AJAX('datos/comarcas.geojson', {
                style: function (feature) {
                    return {

                        fillColor: "#fab81e",
                        color: "#ffffff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.5
                    }
                },
                    onEachFeature: function (feature, layer) {
                        popupContentPol = "<b>" + feature.properties.NOM + "</b>";
                        layer.bindPopup(popupContentPol);
                    },
                
            }).addTo(map);


            var farmaciasPuntoStylePop = new L.GeoJSON.AJAX('datos/farmacias.geojson', {

                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: "#00ff00",
                        color: "#ffffff",
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.8
                    })
                },
                onEachFeature: function (feature, layer) {
                    popupContentP = "<b>" + feature.properties.EQUIPAMENT + "</b>";
                    layer.bindPopup(popupContentP);
                },
            }).addTo(map);

            var carrilsBiciLineaStylePop = new L.GeoJSON.AJAX('datos/carrils-bici.geojson', {
                style: function (feature) {
                    return {
                        color: "#d607f2",
                        weight: 6
                    }
                },
                onEachFeature: function (feature, layer) {
                    popupContentL = "<b>" + feature.properties.TOOLTIP + "</b>";
                    layer.bindPopup(popupContentL);
                },
            }).addTo(map);
            
    ```   
 
!!! example "GeoJson remoto"

    ```javascript

      var rivers = new L.GeoJSON.AJAX(
        'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_rivers_europe.geojson', {
            
            style: function (feature) {
                return {
                    color: "#00ffe1",
                    weight: 6
                }
            },
        }).addTo(map);

             
    ```

 -->




 
